<% # provide :page_title, "Invite new member" %>
<% random_password = Member.new_token %>
<% fields = [
  {
    fieldType: "text",
    attribute: "member[first_name]",
    attributeName: "First name",
    autofocus: true
  },
  {
    fieldType: "text",
    attribute: "member[last_name]",
    attributeName: "Last name",
  },
  {
    fieldType: "email",
    attribute: "member[email]",
    attributeName: "Email",
  },
  {
    fieldType: "checkbox",
    attribute: "send_invitation",
    attributeName: "Send invitation email",
    defaultValue: false
  }
]

create_new_fields = [
  {
    fieldType: "p",
    text: "Choose a name and a start date for the new Project.",
    isVisibleIfChecked: "new_or_existing#new",
  },
  {
    fieldType: "text",
    attribute: "project[name]",
    attributeName: "Project name",
    isVisibleIfChecked: "new_or_existing#new",
  },
  {
    fieldType: "date",
    attribute: "project[start_date]",
    attributeName: "Project start",
    defaultValue: Date.current.beginning_of_month.next_month,
    isVisibleIfChecked: "new_or_existing#new",
  }, 
  {
    fieldType: "number",
    attribute: "monthly_rent",
    attributeName: "Monthly rent",
    defaultValue: 0,
    isVisibleIfChecked: "new_or_existing#new",
  }
]

# If member has no projects, only show the create
# new project form
if @projects.empty?
  puts "No projects found, showing new project form only"
  # Create new only
  fields << {
    fieldType: "radio",
    attribute: "new_or_existing",
    attributeName: "New Project",
    defaultValue: "new",
    checked: true,
    hidden: true
  }
else
  # Let user choose between creating a new poject
  # and selecting an exisitng
  fields.concat(
    [
      {
        fieldType: "h4",
        text: "Assign Project to the new member"
      },
      {
        fieldType: "flex-items",
        items: [
          {
            fieldType: "radio",
            attribute: "new_or_existing",
            attributeName: "Create new Project",
            defaultValue: "new",
          },
          {
            fieldType: "radio",
            attribute: "new_or_existing",
            attributeName: "Choose existing Project",
            defaultValue: "existing",
            checked: @projects.count == 1
          }
        ]
      },
    ]
  )
end

fields.concat(create_new_fields)
fields.concat(
  [
    {
      fieldType: "select",
      attribute: "project_id",
      attributeName: "Select an existing Project",
      isVisibleIfChecked: "new_or_existing#existing",
      defaultValue: @projects.count == 1 ? @projects.first.id : 0,
      options: @projects.map { |p| [p.id, p.name] }.unshift([0, "Choose Project"]),
    },
    {
      fieldType: "p",
      text: "Select which month the new member joins the Project. This is the first month to pay rent for."
    },
    {
      fieldType: "flex-items",
      items: [
        {
          fieldType: "select",
          attribute: "joined_at_m",
          attributeName: "",
          options: (1..12).map {|m| [m, Date::MONTHNAMES[m]]},
          defaultValue: @projects.count == 1 ? @projects.first.start_date.month : Date.current.next_month.month
        },
        {
          fieldType: "select",
          attribute: "joined_at_y",
          attributeName: "",
          options: (2000..20.years.from_now.year).map {|y| [y, y]},
          defaultValue: @projects.count == 1 ? @projects.first.start_date.year : Date.current.year
        },
      ]
    },
    {
      fieldType: "p",
      text: "If the new member will only join for a limited time, select the last month to pay rent for as well, otherwise just leave it as it is."
    },
    {
      fieldType: "flex-items",
      items: [
        {
          fieldType: "select",
          attribute: "left_at_m",
          attributeName: "",
          options: (1..12).map {|m| [m, Date::MONTHNAMES[m]]},
          defaultValue: Date.current.next_month.month
        },
        {
          fieldType: "select",
          attribute: "left_at_y",
          attributeName: "",
          options: (2000..100.years.from_now.year).map {|y| [y, y]},
          defaultValue: 50.years.from_now.year
        }
      ]
    },
    # {
    #   fieldType: "p",
    #   text: "Auto generated password. The member will be prompted to change this when logging in for the first time."
    # },
    {
      fieldType: "password",
      attribute: "member[password]",
      attributeName: "Password",
      defaultValue: random_password,
      hidden: true
    },
    {
      fieldType: "password",
      attribute: "member[password_confirmation]",
      attributeName: "Confirm password",
      defaultValue: random_password,
      hidden: true
    },
    {
      fieldType: "submit",
      attributeName: "Invite new Member"
    }
  ]
) %>

<%= react_component 'Form', 
authenticity_token: form_authenticity_token, 
action: invite_path,
title: "Invite new member",
fields: fields %>